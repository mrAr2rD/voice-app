<% content_for :page_title, "Новая озвучка" %>

<div class="max-w-2xl mx-auto animate-fade-in">

  <!-- Form Card -->
  <div class="rounded-2xl p-8" style="background: var(--color-abyss); border: 1px solid var(--color-graphite);">
    <%= form_with model: @voice_generation, data: { controller: "provider-selector" }, class: "space-y-6" do |f| %>
      <% if @voice_generation.errors.any? %>
        <div class="rounded-xl p-4" style="background: rgba(255, 55, 95, 0.1); border: 1px solid rgba(255, 55, 95, 0.2);">
          <ul class="text-sm space-y-1" style="color: var(--color-coral);">
            <% @voice_generation.errors.full_messages.each do |message| %>
              <li class="flex items-center">
                <svg class="w-4 h-4 mr-2 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
                </svg>
                <%= message %>
              </li>
            <% end %>
          </ul>
        </div>
      <% end %>

      <!-- Text Input -->
      <div>
        <%= f.label :text, class: "block text-sm font-medium mb-2", style: "color: var(--color-cloud);" do %>
          Текст для озвучки
        <% end %>
        <%= f.text_area :text, rows: 6, required: true, maxlength: 5000,
            placeholder: "Введите текст, который нужно озвучить...",
            class: "w-full px-4 py-3 rounded-xl transition-all duration-200 focus:outline-none focus:ring-2 resize-none",
            style: "background: var(--color-obsidian); border: 1px solid var(--color-graphite); color: var(--color-snow); --tw-ring-color: var(--color-neon-purple);",
            data: { action: "input->provider-selector#updateCharCount" } %>
        <p class="mt-2 text-xs" style="color: var(--color-mist);">
          <span data-provider-selector-target="charCount">0</span> / 5000 символов
        </p>
      </div>

      <!-- Provider Selection -->
      <div>
        <label class="block text-sm font-medium mb-3" style="color: var(--color-cloud);">Провайдер</label>
        <div class="grid grid-cols-2 gap-4">
          <!-- ElevenLabs -->
          <label class="relative flex cursor-pointer rounded-xl p-5 transition-all duration-300"
                 style="background: var(--color-obsidian); border: 2px solid var(--color-neon-purple);"
                 data-action="click->provider-selector#selectProvider"
                 data-provider="elevenlabs"
                 data-provider-selector-target="elevenlabsCard">
            <%= f.radio_button :provider, "elevenlabs", checked: true, class: "sr-only", data: { provider_selector_target: "providerInput" } %>
            <span class="flex flex-1 flex-col">
              <span class="flex items-center mb-2">
                <span class="w-8 h-8 rounded-lg flex items-center justify-center mr-2"
                      style="background: rgba(94, 92, 230, 0.15);">
                  <svg class="w-4 h-4" style="color: var(--color-neon-purple);" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19V6l12-3v13M9 19c0 1.105-1.343 2-3 2s-3-.895-3-2 1.343-2 3-2 3 .895 3 2zm12-3c0 1.105-1.343 2-3 2s-3-.895-3-2 1.343-2 3-2 3 .895 3 2zM9 10l12-3"/>
                  </svg>
                </span>
                <span class="font-semibold" style="color: var(--color-snow);">ElevenLabs</span>
              </span>
              <span class="text-sm" style="color: var(--color-mist);">Высокое качество, много голосов</span>
            </span>
          </label>

          <!-- OpenAI -->
          <label class="relative flex cursor-pointer rounded-xl p-5 transition-all duration-300"
                 style="background: var(--color-obsidian); border: 2px solid transparent;"
                 data-action="click->provider-selector#selectProvider"
                 data-provider="openai"
                 data-provider-selector-target="openaiCard">
            <%= f.radio_button :provider, "openai", class: "sr-only", data: { provider_selector_target: "providerInput" } %>
            <span class="flex flex-1 flex-col">
              <span class="flex items-center mb-2">
                <span class="w-8 h-8 rounded-lg flex items-center justify-center mr-2"
                      style="background: rgba(48, 209, 88, 0.15);">
                  <svg class="w-4 h-4" style="color: var(--color-neon-green);" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"/>
                  </svg>
                </span>
                <span class="font-semibold" style="color: var(--color-snow);">OpenAI</span>
              </span>
              <span class="text-sm" style="color: var(--color-mist);">Быстро, стабильно</span>
            </span>
          </label>
        </div>
      </div>

      <!-- Voice Selection -->
      <div data-provider-selector-target="voiceSection">
        <label class="block text-sm font-medium mb-2" style="color: var(--color-cloud);">Голос</label>

        <div data-provider-selector-target="elevenlabsVoices">
          <% voice_options = [] %>
          <% if @cloned_voices&.any? %>
            <% voice_options << ["--- Мои голоса ---", nil, { disabled: true }] %>
            <% @cloned_voices.each do |cv| %>
              <% voice_options << ["#{cv.name} (клон)", cv.elevenlabs_voice_id] %>
            <% end %>
            <% voice_options << ["--- Стандартные голоса ---", nil, { disabled: true }] %>
          <% end %>
          <% @elevenlabs_voices.each do |v| %>
            <% voice_options << [v[:name] || v["name"], v[:id] || v["voice_id"]] %>
          <% end %>
          <%= f.select :voice_id, options_for_select(voice_options),
              { include_blank: "Выберите голос" },
              class: "w-full px-4 py-3 rounded-xl transition-all duration-200 focus:outline-none focus:ring-2 appearance-none cursor-pointer",
              style: "background: var(--color-obsidian); border: 1px solid var(--color-graphite); color: var(--color-snow); --tw-ring-color: var(--color-neon-purple);",
              data: { provider_selector_target: "elevenlabsSelect" } %>

          <% if @cloned_voices.blank? || @cloned_voices.empty? %>
            <p class="mt-2 text-xs" style="color: var(--color-mist);">
              <%= link_to "Клонировать свой голос", new_cloned_voice_path, style: "color: var(--color-neon-purple);" %> для персонализированной озвучки
            </p>
          <% end %>
        </div>

        <div data-provider-selector-target="openaiVoices" class="hidden">
          <select name="voice_generation[voice_id]"
                  class="w-full px-4 py-3 rounded-xl transition-all duration-200 focus:outline-none focus:ring-2 appearance-none cursor-pointer"
                  style="background: var(--color-obsidian); border: 1px solid var(--color-graphite); color: var(--color-snow); --tw-ring-color: var(--color-neon-green);"
                  data-provider-selector-target="openaiSelect">
            <option value="">Выберите голос</option>
            <% @openai_voices.each do |voice| %>
              <option value="<%= voice[:id] %>"><%= voice[:name] %> - <%= voice[:description] %></option>
            <% end %>
          </select>
        </div>
      </div>

      <%= f.hidden_field :voice_name, data: { provider_selector_target: "voiceNameInput" } %>

      <!-- Project -->
      <% if @projects.any? %>
        <div>
          <%= f.label :project_id, class: "block text-sm font-medium mb-2", style: "color: var(--color-cloud);" do %>
            Проект <span style="color: var(--color-mist);">(опционально)</span>
          <% end %>
          <%= f.select :project_id,
              options_from_collection_for_select(@projects, :id, :name, @voice_generation.project_id),
              { include_blank: "Без проекта" },
              class: "w-full px-4 py-3 rounded-xl transition-all duration-200 focus:outline-none appearance-none cursor-pointer",
              style: "background: var(--color-obsidian); border: 1px solid var(--color-graphite); color: var(--color-snow);" %>
        </div>
      <% end %>

      <!-- Submit -->
      <%= f.submit "Сгенерировать озвучку",
          class: "w-full py-4 rounded-xl font-semibold text-lg transition-all duration-300 hover:scale-[1.02] cursor-pointer",
          style: "background: linear-gradient(135deg, var(--color-neon-purple) 0%, var(--color-neon-pink) 100%); color: white; box-shadow: 0 10px 40px rgba(94, 92, 230, 0.3);" %>
    <% end %>
  </div>

</div>
